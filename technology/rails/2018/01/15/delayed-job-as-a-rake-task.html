<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Delayed Job as a rake task</title>
  <meta name="description" content="Delayed Job is a great and simple edition to background jobs in a Rails application. But if you don’t have the memory or resources to run a background thread...">

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800|Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/blog/css/bootstrap.min.css">
  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="https://weavelabs.com/blog/technology/rails/2018/01/15/delayed-job-as-a-rake-task.html">
  <link rel="alternate" type="application/rss+xml" title="WeaveLabs Blog" href="https://weavelabs.com/blog/feed.xml">
  <link rel="shortcut icon" href="/favicon.png">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>


  <body>

    <header class="site-header">

  <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/blog/">WeaveLabs Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/blog/">View All Posts</a>
                    </li>
                    <li>
                        <a href="https://weavelabs.com">Visit WeaveLabs.com</a>
                    </li>
                </ul>
            </div>
            <!-- <div class="trigger">
              
                
              
                
              
                
              
            </div> -->

        </div>
        <!-- /.container -->
    </nav>

</header>


    <!-- Navigation -->



    <div class="page-content">
      <div class="wrapper">
        <header class="intro-header" style="background-image: url('/blog/images/perfrails.jpg')">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>Delayed Job as a rake task</h1>
          <h2 class="subheading">Running delayed job on-demand with a rake task and Heroku Scheduler</h2>
          <span class="meta">Posted by  • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Awin Abi</span></span> on
          <time datetime="2018-01-15T17:32:00+05:30" itemprop="datePublished">Jan 15, 2018</time>
          </span>
        </div>
      </div>
    </div>
  </div>
</header>
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1">
        <p>Delayed Job is a great and simple edition to background jobs in a Rails application. But if you don’t have the memory or resources to run a background thread 24hrs on a server what do you do?</p>

<!--more-->
<p>We were in a similar situation for a client, who was strictly on a shoe string budget, running off Heroku.
The background job was to process some applications, verify and sent emails if they had errors. This was to be done once a day. Running a background job just for this was a bad choice.</p>

<p>Another option was to run this as a rake task, at a set time, use <a href="https://elements.heroku.com/addons/scheduler">Heroku Scheduler</a> to run this at 04:00am every day. But we wanted to try a bit more generic solution.</p>

<p>We decided to stick to write Delayed Job classes, so that in future, it can serve 2 purposes</p>

<ol>
  <li>For more background processing, more jobs we just have to write new classes with <code class="highlighter-rouge">perform</code> methods</li>
  <li>When the app is moved into it’s own private hosting VPS, run a background thread more often, to scale it.</li>
</ol>

<p>So delayed job it was!</p>

<p>But in the current setup, we had to run the jobs as a rake task, triggered once a day at a specific time, while leaving room for a full fledged background process in the future.</p>

<p>Looking at the <a href="https://github.com/collectiveidea/delayed_job">delayed_job source at Github</a> we figured that this could be easily implemented. It internally creates a <code class="highlighter-rouge">Delayed::Worker</code> class and works off all the jobs in the <code class="highlighter-rouge">delayed_jobs</code> table.</p>

<p>The solution was really simple.
Create a rake task in <code class="highlighter-rouge">lib/tasks/delayed_job.rake</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># File lib/tasks/delayed_job.rake</span>

<span class="n">namespace</span> <span class="ss">:delayed_job</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">'Run Delayed job worker'</span>
  <span class="n">task</span> <span class="ss">work: :environment</span> <span class="k">do</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="no">Delayed</span><span class="o">::</span><span class="no">Worker</span><span class="p">.</span><span class="nf">new</span>
    <span class="n">worker</span><span class="p">.</span><span class="nf">work_off</span> <span class="c1">#by default runs 100 rows</span>
  <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<p><strong>For more information on the sources:</strong></p>

<ul>
  <li>
    <p>The rake task for starting delayed job - <a href="https://github.com/collectiveidea/delayed_job/blob/c7a42fb78dc538de46024eb36b31e72916ff21a0/lib/delayed/tasks.rb#L8">delayed/tasks.rb</a></p>
  </li>
  <li>
    <p>The Delayed::Worker start - <a href="https://github.com/collectiveidea/delayed_job/blob/c7a42fb78dc538de46024eb36b31e72916ff21a0/lib/delayed/worker.rb#L156">delayed/worker.rb</a></p>
  </li>
  <li>
    <p>Delayed::Worker work_off definition - <a href="https://github.com/collectiveidea/delayed_job/blob/c7a42fb78dc538de46024eb36b31e72916ff21a0/lib/delayed/worker.rb#L206">delayed/worker.rb#work_off</a></p>
  </li>
</ul>

      </div>
    </div>
  </div>
</article>

      </div>
    </div>

    <!-- <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">WeaveLabs Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>WeaveLabs Blog</li>
          <li><a href="mailto:hello@weavelabs.com">hello@weavelabs.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/weavelabs"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">weavelabs</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/weavelabs"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">weavelabs</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Weave Labs is a technology consulting firm and development house located in the beautiful environs of Kerala, India. We have expertise in building solutions for the web and mobile devises, designing scalable architectures, building Android and iOS applications, and creating fast MVPs using Ruby on Rails, CodeIgnitor, Play, Spring and other modern web frameworks.
</p>
      </div>
    </div>

  </div>

</footer> -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8  col-lg-offset-1 col-md-10 col-md-offset-1">
        <ul class="list-inline">
          <li>
            <a href="https://twitter.com/weavelabs">
              <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          <li>
            <a href="https://www.facebook.com/weavelabs">
              <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="copyright text-muted">Copyright &copy; WeaveLabs 2013 - 2017</p>
      </div>
    </div>
  </div>
</footer>
<script src="/blog/js/jquery.js"></script>
<script src="/blog/js/bootstrap.min.js"></script>
<script src="/blog/js/clean-blog.min.js"></script>
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5704d4a136a85b2f"></script>

<script>
  (function(i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function() {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

  ga('create', 'UA-77527928-1', 'auto');
  ga('send', 'pageview');
</script>


  </body>
</html>
